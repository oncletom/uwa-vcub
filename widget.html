<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">
<head>
  <title>VCUB</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="author" content="Oncle Tom" />
  <meta name="website" content="http://case.oncle-tom.net/code/netvibes/" />
  <meta name="version" content="1.0-alpha" />
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="screenshot" content="" />
  <meta name="thumbnail" content="" />
  <meta name="autoRefresh" content="5" />
  <meta name="apiVersion" content="1.2" />
  <meta name="debugMode" content="true" />
  <!--<link rel="icon" type="image/x-icon" href="" />-->
  <!--<link rel="rich-icon" type="image/png" href="" />-->
  <link rel="stylesheet" type="text/css" href="http://www.netvibes.com/themes/uwa/style.css" />
  <script type="text/javascript" src="http://www.netvibes.com/js/UWA/load.js.php?env=Standalone"></script>
  <script type="text/javascript">
    //<![CDATA[
    const FEED_URI = 'http://www.vcub.fr/stations/feed.rss';
    const BIKE_NS =  'http://dev.vcub.fr/ns/bikes/';
    const NS_ACCEPT_TEST_SELECTOR = 'bikes:station-id';
    const F = function(){};
    var T = TOOLKIT = {feed: null, NS_PREFIX_REMOVAL: null};
    var pager = {};
    var $e = UWA.$element,
        create = widget.createElement;
    
    if (document.location && document.location.hostname == 'localhost') {
      UWA.proxies.ajax = 'proxy.php';
    }

    /**
     * Retrieves the service feed and preconfigures fixes
     * 
     * @param {String} uri Service URI to call
     * @param {Function} callback Function executed after fetching
     */
    TOOLKIT.getFeed = function(uri, callback){
      var callback = callback || F;

      UWA.Data.getXml(uri, function(xml){
        T.feed = xml;

        widget.log('Feed '+uri+' cached.');
        
        //do we need to calculate a prefix removal for later queries?
        if (T.NS_PREFIX_REMOVAL === null && xml.getElementsByTagName('item').length)
        {
          T.NS_PREFIX_REMOVAL = xml.getElementsByTagName(NS_ACCEPT_TEST_SELECTOR).length ? '' : /^([^:]+):/
        }
        
        callback.call(this, T.feed);
      });
    };

    /**
     * Returns the text value of a DOM Query
     * 
     * Contains fixes for NS query for various browser
     * 
     * @param {Object} el
     * @param {String} tagName
     */
    TOOLKIT.getTagNameText = function(el, tagName){
      var rs = el.getElementsByTagName(T.NS_PREFIX_REMOVAL ? tagName.replace(T.NS_PREFIX_REMOVAL, '') : tagName);
      
      return rs.length ? (!!rs[0].textContent ? rs[0].textContent : rs[0].innerText) : null;
    };

    /**
     * Building the pager based on XML Feed
     * 
     * @param {Document} feed XML Document formated as RSS2+GeoRSS
     */
    function buildPager(feed)
    {
      var items =   feed.getElementsByTagName('item');

      pager = new UWA.Controls.Pager({
        module:     widget,
        limit:      widget.getValue('limit'),
        offset:     widget.getValue('offset'),
        dataArray:  items
      });
      pager.onChange = function(offset){
        widget.setValue('offset', offset);
        buildPager(T.feed);
      };
      
      var table = create('table', {'class': 'nv-datagrid'});
      buildTableData(feed, items, table);
      $e(widget.body.getElementsByClassName('stations-list')[0]).setContent(table);
      $e(widget.body.getElementsByClassName('stations-pagination')[0]).setContent(pager.getContent());
    }

    function buildTableData(feed, items, table, options)
    {
      var options = options || {};
          options.from = options.from || widget.getValue('offset');
          options.to = options.to || widget.getInt('offset') + widget.getInt('limit');

      var tbody = create('tbody'),
          data =  [
            {title: 'Station Name', 'className': 'station-name', 'nodeType': 'td', 'tagName': 'title', 'type': 'string'},
            {title: 'Bikes', 'className': 'station-available-vehicules', 'nodeType': 'td', 'tagName': 'bikes:available-vehicules', 'type': 'int'},
            {title: 'Slots', 'className': 'station-available-slots', 'nodeType': 'td', 'tagName': 'bikes:available-slots', 'type': 'int'}
          ];

      /*
       * Header
       */
      var thead = create('thead'),
          tr =    create('tr');
      
      data.each(function(column){
        var th = create('th');
        
        $e(th).setContent(column.title);
        tr.appendChild(th);
      });

      tr.appendChild(create('th'));
      thead.appendChild(tr);

      for (var i = options.from; i < (items.length < options.to ? items.length : options.to); i++)
      {
        var item = items[i],
            station_id = T.getTagNameText(item, 'bikes:station-id'),
            tr = create('tr', {'class': 'station-'+station_id+' '+(i%2 ? 'even' : 'odd')}),
            td;

        /*
         * Data column
         */
        data.each(function(column){
          var column_value = T.getTagNameText(item, column.tagName),
              css_class = [column.className, 'type-'+column.type];

          if (column.type == 'int')
          {
            css_class.push(parseInt(column_value) ? 'value-notnull' : 'value-null');
          }

          td = create(column.nodeType, {'class': css_class.join(' ')});
          $e(td).setContent(column_value);
          tr.appendChild(td);

          delete css_class, column_value, td;
        });

        /*
         * Last Column
         */
        td = create('td', {'class': 'station-favourite'});
        var fave = create('img', {'src' : 'http://dev.netvibes.com/doc/lib/tpl/netvibes_devdoc3/images/star.png', 'alt': 'Fave?', 'class': 'add-to-fave'});
        
        if (isStationFave(station_id))
        {
          fave.className += ' added-to-fave';
        }

        fave.station_id = station_id;
        fave.onclick = updateFaveFromSwitchClick;

        td.appendChild(fave);
        tr.appendChild(td);
        
        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);
    }

    /**
     * Returns if a station is already a fave or not
     * 
     * @param {Integer} station_id
     * 
     * @return {Bool}
     */
    function isStationFave(station_id)
    {
      return (new RegExp('(^|,)'+station_id+'(,|$)')).test(widget.getValue('favourites') || '') ? true : false;
    }

    /**
     * 
     */
    function updateFaveFromSwitchClick()
    {
      var faves = (widget.getValue('favourites') || '').split(','),
          station_id = this.station_id;

      if (isStationFave(station_id))
      {
        faves.each(function(val, i){
          if (val == station_id)
          {
            delete faves[i];
          }
        });

        this.className = this.className.replace(' added-to-fave', '');
      }
      else
      {
        faves.push(station_id);
        this.className += ' added-to-fave';
      }

      widget.setValue('favourites', faves.join(',').replace(',,', ','));
    }

    /**
     * Widget loading
     */
    widget.onLoad = function(){
      widget.log('Widget loading');
      widget.setValue('offset', 0);
      TOOLKIT.getFeed(FEED_URI, buildPager);
    };

    /**
     * Widget reloading
     * 
     * Basically the same as loading except we remains on the same page
     * It's just because we think about the user
     */
    widget.onRefresh = function(){
      widget.log('Widget reloading');
      TOOLKIT.getFeed(FEED_URI, buildPager);
    };
  //]]>
  </script>
  <style type="text/css" media="all">
    .value-null{
      background-color: #ffb7b2;
      color: #c00;
    }
    
    .value-notnull{
      /*background-color: #d9ffd9;*/
      color: #008000;
    }
    
    .type-int,
    .type-float,
    .type-numeric,
    .station-favourite{
      text-align: center;
    }
    
    /*
     * Add to fave
     */
    .add-to-fave{
      cursor: pointer;
      opacity: 0.4;
      filter: alpha(opacity = 40);
      zoom: 1;
    }
    .added-to-fave{
      opacity: 1;
      filter: alpha(opacity = 100);
    }
  </style>
  <widget:preferences>
    <preference name="limit" type="hidden" defaultValue="20" />
    <preference name="offset" type="hidden" defaultValue="0" />
    <preference name="favourites" type="hidden" defaultValue="" />
  </widget:preferences>
</head>
<body>
  <div class="stations-wrapper">
    <div class="stations-list">Loading...</div>
    <div class="stations-pagination"></div>
  </div>
  
</body>
</html>
