<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">
<head>
  <title>VCUB - Disponibilité des vélos</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="author" content="Oncle Tom" />
  <meta name="website" content="http://case.oncle-tom.net/code/netvibes/" />
  <meta name="version" content="1.0-beta" />
  <meta name="description" content="Affichage des disponibilités des vélos en temps quasi-réel. Gestion des stations favorites." />
  <meta name="keywords" content="vcub, v3, tbc, infotbc, bordeaux, cub, vls, vélo, bicycle, bicyclette" />
  <meta name="screenshot" content="http://github.com/oncletom/uwa-vcub/raw/master/screenshot.png" />
  <meta name="thumbnail" content="http://github.com/oncletom/uwa-vcub/raw/master/thumbnail.png" />
  <meta name="autoRefresh" content="5" />
  <meta name="apiVersion" content="1.2" />
  <meta name="debugMode" content="true" />
  <link rel="icon" type="image/x-icon" href="http://www.vcub.fr/favicon.ico" />
  <link rel="rich-icon" type="image/png" href="http://www.vcub.fr/sites/default/themes/vcub2010/favicon.png" />
  <link rel="stylesheet" type="text/css" href="http://www.netvibes.com/themes/uwa/style.css" />
  <script type="text/javascript" src="http://www.netvibes.com/js/UWA/load.js.php?env=Standalone"></script>
  <script type="text/javascript">
    //<![CDATA[
    const FEED_URI = 'http://keolis-vls.projects.clever-age.net/stations/feed/json';
    const F = function(){};
    var T = TOOLKIT = {feed: null};
    var i18n = {catalogs: {en: {}}, catalog: 'en', translate: function(string){ return string; }, setCatalog: function(catalog){ this.catalog = catalog; }};
    var pager = {};
    var $e = UWA.$element,
        create = widget.createElement,
        __ = i18n.translate;
    
    if (document.location && document.location.hostname == 'localhost') {
      UWA.proxies.ajax = 'proxy.php';
    }

    /*
     * I18n overload
     */
    i18n.setCatalog = function(catalog){
      if (!this.catalogs[catalog])
      {
        i18n.catalogs[catalog] = {};
      }
      
      i18n.catalog = catalog;
    };

    __ = i18n.translate = function(string){
      return i18n.catalogs[i18n.catalog][string] || string;
    };

    /**
     * Retrieves the service feed
     * 
     * @param {String} uri Service URI to call
     * @param {Function} callback Function executed after fetching
     */
    TOOLKIT.getFeed = function(uri, callback){
      var callback = callback || F;

      UWA.Data.getJson(uri, function(json){
        T.feed = json;

        widget.log('Feed '+uri+' cached.');
        callback.call(this, T.feed);
      });
    };

    /**
     * 
     * @param {Object} feed
     */
    function buildDisplay(feed)
    {
      var feed = feed || T.feed;
      widget.log('buildDisplay');

      buildPager(feed);
      buildFavourites(feed, (widget.getValue('favourites') || '').split(','));
      buildMetadata(feed);
    }

    /**
     * Building the display of favourite stations
     * 
     * @param {Document} feed XML Document formated as RSS2+GeoRSS
     * @param {Array} faves Array of Stations ID
     */
    function buildFavourites(feed, faves)
    {
      var items = feed.stations,
          filteredItems = [],
          container = $e(widget.body.getElementsByClassName('favourite-stations-list')[0]);
      widget.log('buildFavourites');

      for (var i = 0, items_length = items.length; i < items_length; i++)
      {
        var item = items[i];
        
        if (isStationFave(item['bikes:station-id']))
        {
          filteredItems.push(item);
        }
      }

      if (widget.getBool('display-favourites') && filteredItems.length)
      {
        var table = create('table', {'class': 'nv-datagrid'});
        buildTableData(feed, filteredItems, table);
        
        container.setContent('<h2>'+__('Favourite Stations')+'</h2>')
        container.addContent(table);
        container.removeClassName('hidden');
      }
      else
      {
        container.setContent('');
        container.addClassName('hidden');
      }

      delete items, filteredItems, table, container;
    }

    /**
     * Displaying metadata
     * 
     * @param {Document} feed XML Document formated as RSS2+GeoRSS
     */
    function buildMetadata(feed)
    {
      var $c = $e(widget.body.getElementsByClassName('metadata')[0]).setContent(''),
          meta;
      widget.log('buildMetadata');

      //Last updated at
      meta = create('p', {'class': 'metadata-updated-at', 'content': 'test'});
      meta.innerHTML = __('Last updated at')+' ';
      meta.innerHTML += (new Date(feed['pubDate'])).toLocaleString();
      $c.addContent(meta);
    }

    /**
     * Building the pager based on XML Feed
     * 
     * @param {Document} feed XML Document formated as RSS2+GeoRSS
     */
    function buildPager(feed)
    {
      widget.log('buildPager');
      var items = feed.stations,
          container = $e(widget.body.getElementsByClassName('stations-list')[0]),
          pagerContainer = $e(widget.body.getElementsByClassName('stations-pagination')[0]);

      pager = new UWA.Controls.Pager({
        module:     widget,
        limit:      widget.getValue('limit'),
        offset:     widget.getValue('offset'),
        dataArray:  items
      });
      pager.onChange = function(offset){
        widget.setValue('offset', offset);
        buildPager(T.feed);
      };

      if (widget.getBool('display-stations') && items.length)
      {
        var table = create('table', {'class': 'nv-datagrid'});
        buildTableData(feed, items, table);
        container.setContent('<h2>'+__('Stations List')+'</h2>')
        container.addContent(table);
        container.removeClassName('hidden');
        pagerContainer.setContent(pager.getContent()); 
      }
      else
      {
        container.addClassName('hidden');
        pagerContainer.addClassName('hidden');
      }

      delete table, feed, items, container, pagerContainer;
    }

    /**
     * Build a table data based on item list
     * 
     * @param {Document} feed
     * @param {Array} items
     * @param {Element} table
     * @param {Object} options
     */
    function buildTableData(feed, items, table, options)
    {
      var options = options || {};
          options.from = options.from || widget.getValue('offset');
          options.to = options.to || widget.getInt('offset') + widget.getInt('limit');

      var tbody = create('tbody'),
          data =  [
            {title: __('N°'), 'className': 'station-id', 'nodeType': 'td', 'tagName': 'bikes:station-id', 'type': 'numeric'},
            {title: __('Station Name'), 'className': 'station-name', 'nodeType': 'td', 'tagName': 'title', 'type': 'string'},
            {title: __('Bikes'), 'className': 'station-available-vehicules', 'nodeType': 'td', 'tagName': 'bikes:available-vehicules', 'type': 'int'},
            {title: __('Slots'), 'className': 'station-available-slots', 'nodeType': 'td', 'tagName': 'bikes:available-slots', 'type': 'int'}
          ];

      /*
       * Header
       */
      var thead = create('thead'),
          tr =    create('tr');
      
      data.each(function(column){
        var th = create('th');
        
        $e(th).setContent(column.title);
        tr.appendChild(th);
      });

      tr.appendChild(create('th'));
      thead.appendChild(tr);

      for (var i = options.from; i < (items.length < options.to ? items.length : options.to); i++)
      {
        var item = items[i],
            station_id = item['bikes:station-id'],
            tr = create('tr', {'class': 'station-'+station_id+' '+(i & 1 ? 'odd' : 'even')}),
            td;

        /*
         * Data column
         */
        data.each(function(column){
          var column_value = item[column.tagName],
              css_class = [column.className, 'type-'+column.type];

          if (column.type == 'int')
          {
            css_class.push(parseInt(column_value) ? 'value-notnull' : 'value-null');
          }

          td = create(column.nodeType, {'class': css_class.join(' ')});
          $e(td).setContent(column_value);
          tr.appendChild(td);

          delete css_class, column_value, td;
        });

        /*
         * Last Column
         */
        td = create('td', {'class': 'station-favourite'});
        var fave = create('img', {'src' : 'http://dev.netvibes.com/doc/lib/tpl/netvibes_devdoc3/images/star.png', 'alt': __('Fave?'), 'class': 'add-to-fave'});
        
        if (isStationFave(station_id))
        {
          fave.className += ' added-to-fave';
        }

        fave.station_id = station_id;
        fave.onclick = updateFaveFromSwitchClick;

        td.appendChild(fave);
        tr.appendChild(td);
        
        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);
    }

    /**
     * Returns if a station is already a fave or not
     * 
     * @param {Integer} station_id
     * 
     * @return {Bool}
     */
    function isStationFave(station_id)
    {
      return (new RegExp('(^|,)'+station_id+'(,|$)')).test(widget.getValue('favourites') || '') ? true : false;
    }

    /**
     * Update the favourite button on click + user preferences
     * 
     * Must be bound to a DOM Element
     */
    function updateFaveFromSwitchClick()
    {
      var faves = (widget.getValue('favourites') || '').split(','),
          station_id = this.station_id || 0;

      if (isStationFave(station_id))
      {
        faves.each(function(val, i){
          if (val == station_id)
          {
            delete faves[i];
          }
        });

        this.className = this.className.replace(' added-to-fave', '');
      }
      else
      {
        faves.push(station_id);
        this.className += ' added-to-fave';
      }

      widget.setValue('favourites', faves.join(',').replace(',,', ','));
      buildDisplay(T.feed);
    }

    /**
     * Widget loading
     */
    widget.onLoad = function(offset){
      widget.log('Widget loading');
      widget.setValue('offset', offset || 0);
      TOOLKIT.getFeed(FEED_URI, buildDisplay);
    };

    /**
     * Widget reloading
     * 
     * Basically the same as loading except we remains on the same page
     * It's just because we think about the user
     */
    widget.onRefresh = function(){
      widget.log('Widget reloading');
      widget.onLoad(widget.getInt('offset'));
    };
    
    /*
     * i18n catalogs
     */
    i18n.catalogs.fr = {
      'Favourite Stations': 'Stations préférées',
      'Last updated at': 'Dernière mise à jour le',
      'Stations List': 'Liste des stations',
      'N°': 'N°',
      'Station Name': 'Station',
      'Bikes': 'Vélos',
      'Slots': 'Emplacements',
      'Fave?': 'Favori ?'
    };
    i18n.setCatalog(widget.locale);
  //]]>
  </script>
  <style type="text/css" media="all">
    table,
    .metadata,
    table.nv-datagrid{
      margin-bottom: 1em;
    }

    /*
     * UI Helpers
     */
    .hidden{
      display: none;
    }

    /*
     * Data representation
     */
    .value-null{
      background-color: #ffb7b2;
      color: #c00;
    }
    
    .value-notnull{
      /*background-color: #d9ffd9;*/
      color: #008000;
    }
    
    .type-int,
    .type-float,
    .type-numeric,
    .station-favourite{
      text-align: center;
    }
    
    /*
     * Add to fave
     */
    .add-to-fave{
      cursor: pointer;
      opacity: 0.4;
      filter: alpha(opacity = 40);
      zoom: 1;
    }
    .added-to-fave{
      opacity: 1;
      filter: alpha(opacity = 100);
    }
  </style>
  <widget:preferences>
    <preference name="offset" type="hidden" defaultValue="0" />
    <preference name="favourites" type="hidden" defaultValue="" />
    <preference name="display-favourites" type="boolean" defaultValue="true" label="Afficher les stations favorites" />
    <preference name="display-stations" type="boolean" defaultValue="true" label="Afficher la liste des stations" />
    <preference name="limit" type="range" min="5" max="50" step="5" defaultValue="10" label="Nombre de stations par page"></preference>
  </widget:preferences>
</head>
<body>
  <div class="stations-wrapper">
    <div class="metadata"></div>
    <div class="favourite-stations-list"></div>
    <div class="stations-list">Loading...</div>
    <div class="stations-pagination"></div>
  </div>
</body>
</html>