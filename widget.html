<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">
<head>
  <title>VCUB</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="author" content="Oncle Tom" />
  <meta name="website" content="http://case.oncle-tom.net/code/netvibes/" />
  <meta name="version" content="1.0-alpha" />
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="screenshot" content="" />
  <meta name="thumbnail" content="" />
  <meta name="autoRefresh" content="5" />
  <meta name="apiVersion" content="1.2" />
  <meta name="debugMode" content="true" />
  <!--<link rel="icon" type="image/x-icon" href="" />-->
  <!--<link rel="rich-icon" type="image/png" href="" />-->
  <link rel="stylesheet" type="text/css" href="http://www.netvibes.com/themes/uwa/style.css" />
  <script type="text/javascript" src="http://www.netvibes.com/js/UWA/load.js.php?env=Standalone"></script>
  <script type="text/javascript">
    //<![CDATA[
    const FEED_URI = 'http://www.vcub.fr/stations/feed.rss';
    const BIKE_NS =  'http://dev.vcub.fr/ns/bikes/';
    const F = function(){};
    var T = TOOLKIT = {feed: null};
    var pager = {};
    
    if (document.location && document.location.hostname == 'localhost') {
      UWA.proxies.ajax = 'proxy.php';
    }

    TOOLKIT.getFeed = function(uri, callback){
      var callback = callback || F;

      UWA.Data.getXml(uri, function(xml){
        T.feed = xml;

        widget.log('Feed '+uri+' cached.');
        callback.call(this, T.feed);
      });
    };

    function buildPager(feed)
    {
      var items =   feed.getElementsByTagName('item'),
          create =  widget.createElement;

      pager = new UWA.Controls.Pager({
        module:     widget,
        limit:      widget.getValue('limit'),
        offset:     widget.getValue('offset'),
        dataArray:  items
      });
      pager.onChange = function(offset){
        widget.setValue('offset', offset);
        buildPager(T.feed);
      };
      
      var table = create('table'),
          tbody = create('tbody'),
          $e =    UWA.$element,
          from =  widget.getValue('offset'),
          to =    widget.getInt('offset') + widget.getInt('limit'),
          data =  [
            {title: 'Station Name', 'className': 'station-name', 'nodeType': 'th', 'tagName': 'title', 'type': 'string'},
            {title: 'Bikes', 'className': 'station-available-vehicules', 'nodeType': 'td', 'tagName': ['bikes:available-vehicules', 'available-vehicules'], 'type': 'int'},
            {title: 'Slots', 'className': 'station-available-slots', 'nodeType': 'td', 'tagName': ['bikes:available-slots', 'available-slots'], 'type': 'int'}
          ];

      /*
       * Fixing NS lookup (Chromium does not like query with NS:prefix for example
       */
      for (var j = 0, j_length = data.length; j < j_length; j++)
      {
        var column = data[j];

        if (typeof column.tagName === 'object')
        {
          column.tagName.each(function(value){
            if (feed.getElementsByTagName(value).length)
            {
              column.tagName = value;
            }
          });
        }
      }

      /*
       * Header
       */
      var thead = create('thead'),
          tr =    create('tr');
      for (var j = 0, j_length = data.length; j < j_length; j++)
      {
        var column = data[j],
            th =     create('th');
        
        $e(th).setContent(column.title);
        tr.appendChild(th);
      }
      
      thead.appendChild(tr);

      for (var i = from; i < (items.length < to ? items.length : to); i++)
      {
        var tr = create('tr'),
            td,
            item = items[i];
        
        for (var j = 0, j_length = data.length; j < j_length; j++)
        {
          var column = data[j],
              domElement = item.getElementsByTagName(column.tagName).length ? item.getElementsByTagName(column.tagName)[0] : null,
              column_value = domElement ? domElement.textContent : 'N/A',
              css_class = [column.className, 'type-'+column.type];
              
          if (column.type == 'int')
          {
            css_class.push(parseInt(column_value) ? 'value-notnull' : 'value-null');
          }

          td = create(column.nodeType, {'class': css_class.join(' ')});
          $e(td).setContent(column_value);
          tr.appendChild(td);
          
          delete css_class, column, column_value, td;
        }
        
        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      $e(widget.body.getElementsByClassName('stations-list')[0]).setContent(table);
      $e(widget.body.getElementsByClassName('stations-pagination')[0]).setContent(pager.getContent());
    }

    widget.onLoad = function(){
      widget.setValue('offset', 0);
      TOOLKIT.getFeed(FEED_URI, buildPager);
    };
  //]]>g
  </script>
  <style type="text/css" media="all">
    table{
      width: 100%;
    }
    
    .value-null{
      background-color: #ffb7b2;
      color: #c00;
    }
    
    .value-notnull{
      /*background-color: #d9ffd9;*/
      color: #008000;
    }
    
    .type-int,
    .type-float,
    .type-numeric{
      text-align: center;
    }
    
    .station-name{
      font-weight: normal;
    }
  </style>
  <widget:preferences>
    <preference name="limit" type="hidden" defaultValue="20" />
    <preference name="offset" type="hidden" defaultValue="0" />
  </widget:preferences>
</head>
<body>
  <div class="stations-wrapper">
    <div class="stations-list">Loading...</div>
    <div class="stations-pagination"></div>
  </div>
  
</body>
</html>
